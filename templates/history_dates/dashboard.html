{% extends "base_raw.html" %}

{% block base_content %}
    <div class="main-dashboard-container">
        <div class="main-dashboard-eng-box">
            <p>History dates</p>
            <input class="search-input" placeholder="At the end tap ENTER" onkeydown="searchHistoryDates(event)" />
            {% if user.is_authenticated and user.is_superuser %}
                <button class="add-button" onclick="showAddWord()">Add date</button>
            {% endif %}
            <a class="check-knowledge-button" href="{% url "hist_task" %}">Test knowledge</a>
        </div>
        <div class="words-eng-container" onscroll="loadWordsScroll(event)">
            <table id="words-list">
                <tr class="words-eng-container-head">
                    <th>Date</th>
                    <th>Events</th>
                </tr>
            </table>
        </div>
    </div>
    <div id="add-word-popup">
        <div>
            {% if user.is_authenticated and user.is_superuser %}
                <h1>Add Date</h1>
                <div id="add-word-first-box">
                    <input id="first-input" placeholder="Fill in the date & press ENTER" onkeydown="addWordFirstPart(event)" />
                    <button onclick="closeAddWord()">Cancel</button>
                </div>
                <div id="add-word-second-box">
                    <div class="add-word-second-box-suggestions" id="suggestions-container">
                    </div>
                    <input id="second-input" placeholder="Fill in the events & press ENTER" onkeydown="addWordSecondPart(event)" />
                    <div class="add-word-second-box-buttons">
                        <button class="add-word-second-box-cancel-button" onclick="closeAddWord()">Cancel</button>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
{% endblock %}

{% block script %}
    let addWordEl = document.getElementById("add-word-popup");
    let addWordFirst = document.getElementById("add-word-first-box");
    let addWordSecond = document.getElementById("add-word-second-box");
    let suggestionsCont = document.getElementById("suggestions-container");
    let wordsList = document.getElementById("words-list");

    let word = "";
    let searchStr = "";
    let translations = [];
    let suggestionsEarly = [];
    let currentPage = 1;
    let csrf = '{{ csrf_token }}';

    addWordEl.style.opacity = 0;
    addWordEl.style.display = 'none';
    {% if user.is_authenticated and user.is_superuser %}
        suggestionsCont.style.display = 'none';
        addWordSecond.style.display = 'none';
    {% endif %}

    loadWordsFirst();

    function displayTd() {
        trs = wordsList.querySelectorAll('tr');
        console.log(trs)

        trs.forEach((el, i) => i % 2 ? el.style.backgroundColor = 'transparent' : el.style.backgroundColor = '#ebedff');

        console.log(trs)
    }

    async function loadWordsFirst() {
        target = document.getElementsByClassName("words-eng-container");

        do {
            await loadWords();
        } while (currentPage && target.scrollHeight == target.clientHeight);
    }

    function loadWordsScroll(e) {
        target = e.target;
        if (currentPage && target.scrollHeight - target.clientHeight - target.scrollTop <= 200) {
            loadWords();
        }
    }

    async function loadWords() {
        if (currentPage) {
            params = new URLSearchParams({
                symbols: searchStr,
                page: currentPage
            })
    
            res = await fetch(`{% url "search_hist_date" %}?${params.toString()}`)
    
            if (res.ok) {
                dataObj = (await res.json());
    
                data = dataObj.data;
                currentPage = dataObj.hasNext ? currentPage + 1 : null

                console.log("Next page: " + currentPage);
    
                data.forEach((e, i) => {
                    let translationsHTML = "";
                    //e.events.forEach((el) => translationsHTML += `<span>${el}</span>`);
                    translationsHTML = e.events;
                    console.log(translationsHTML);
                    wordsList.innerHTML += `
                        <tr>
                            <td>${e.date}</td>
                            <td>
                                {% if user.is_authenticated and user.is_superuser %}
                                    <div class="cross-box-eng-dashboard" onclick="removeYourself(event, '${e.date}')"><p>&#x274c;</p></div>
                                {% endif %}
                                <div>
                                    ${translationsHTML}
                                </div>
                            </td>
                        </tr>
                    `;
                })

                displayTd()
            } else {
                res.text().then(err => addErrorAlert(err));
            }
        }
    }

    function searchHistoryDates(e) {
        searchStr = e.target.value;

        console.log('fuck');

        if (e.keyCode == 13) {
            e.preventDefault();

            wordsList.innerHTML = '<tr class="words-eng-container-head"><th>Word</th><th>Translations</th></tr>';

            currentPage = 1

            loadWords();
        }
    }

    function addWordFirstPart(e) {
        value = e.target.value;
        if (e.keyCode == 13 && value != "") {
            e.preventDefault();

            word = value

            params = new URLSearchParams({
                "date": value
            });

            addWordFirst.style.display = 'none';
            addWordSecond.style.removeProperty("display");
            document.getElementById('second-input').focus();
        }   
    }

    function addTranslation(transl) {
        suggestionsCont.style.removeProperty('display');

        suggestionsCont.insertAdjacentHTML('beforeend', `
            <div class="add-word-translation"><p>${transl}</p><div onclick="removeTranslation(event)">&#x274c;</div></div>
        `
        )

        translations.push(transl);
    }

    function addWordSecondPart(e) {
        value = e.target.value;

        if (e.keyCode == 13) {
            e.preventDefault();

            if (value) {
                e.target.value = '';
                addTranslation(value)
            } else if (translations.length != 0) {
                const formData = new FormData()
                formData.append('date', word)
                console.log(translations)
                formData.append('events', translations.join('; '))

                fetch('{% url 'add_hist_date' %}', {
                    method: 'POST', 
                    headers: {
                        'X-CSRFToken': csrf
                    },
                    body: formData
                }).then((res) => {
                    if (res.ok) {
                        closeAddWord()
                    } else {
                        res.text().then(err => addErrorAlert(err));
                    }
                });
            }
        }
    }

    function removeYourself(e, wordDel) {
        e.target.parentElement.parentElement.parentElement.remove()

        formData = new FormData();
        formData.append('date', wordDel);

        fetch('{% url "delete_hist_date" %}', {
            method: "POST",
            headers: {
                'X-CSRFToken': csrf
            },
            body: formData
        });

        displayTd()
    }

    function removeTranslation(e) {
        parent = e.target.parentElement;
        val = parent.querySelector('p').value

        translations.splice(translations.indexOf(val), 1)
        parent.remove()

        if (translations.length == 0) {
            suggestionsCont.style.display = 'none';
        }
    }

    function showAddWord() {
        console.log('invoked');
        addWordEl.style.removeProperty("display");
        document.getElementById('first-input').focus();
        objAppear((x) => addWordEl.style.opacity = x, 0.25, () => {});
    }

    function closeAddWord() {
        function delCallback() {
            document.getElementById('first-input').value = '';
            document.getElementById('second-input').value = '';
            addWordFirst.style.removeProperty("display");
            word = "";
            translations = [];
            suggestionsEarly = [];
            suggestionsCont.innerHTML = '';
            suggestionsCont.style.display = 'none';
            addWordSecond.style.display = 'none';
            addWordEl.style.display = 'none';


        }

        objDisappear((x) => addWordEl.style.opacity = x, 0.25, delCallback)
    }
{% endblock %}
